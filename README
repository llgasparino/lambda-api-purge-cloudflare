# AWS Lambda API Cloudflare Purger

<p align="left">
  <a href="https://hits.dwyl.com/llgasparino/lambda-api-purge-cloudflare">
    <img src="https://hits.dwyl.com/llgasparino/lambda-api-purge-cloudflare.svg" alt="Visitors"/>
  </a>
  <a href="https://github.com/llgasparino/lambda-api-purge-cloudflare/stargazers">
    <img src="https://img.shields.io/github/stars/llgasparino/lambda-api-purge-cloudflare?style=social" alt="GitHub Stars">
  </a>
  <a href="https://github.com/llgasparino/lambda-api-purge-cloudflare/network/members">
    <img src="https://img.shields.io/github/forks/llgasparino/lambda-api-purge-cloudflare?style=social" alt="GitHub Forks">
  </a>
</p>

<p align="left">
  <img src="https://img.shields.io/badge/Terraform-~>5.0-blue?logo=terraform" alt="Terraform">
  <img src="https://img.shields.io/badge/AWS_Provider-~>5.0-orange?logo=amazon-aws" alt="AWS Provider">
  <img src="https://img.shields.io/badge/Python-3.12-3776AB?logo=python" alt="Python">
</p>

---

Este projeto provisiona um endpoint de API seguro (via AWS API Gateway) que aciona uma fun√ß√£o Lambda para limpar (purgar) o cache de **prefixos** no Cloudflare.

A Lambda √© configurada para rodar dentro de uma VPC, garantindo que todas as requisi√ß√µes de API para o Cloudflare saiam de um IP est√°tico (via AWS NAT Gateway).

## üöÄ Funcionalidades

* **Gatilho:** Endpoint do API Gateway protegido por chave (`x-api-key`).
* **A√ß√£o:** Limpa o cache (purge) de uma lista de prefixos no Cloudflare (ex: `site.com/pasta/`).
* **Rede:** Executa em subnets privadas e usa um NAT Gateway para IP de sa√≠da fixo.
* **Seguran√ßa:** Exige uma chave de API (`x-api-key`) para ser invocado.
* **CORS:** Configurado para aceitar requisi√ß√µes de navegadores (default: `*`).

## üõ†Ô∏è Como Usar a API

Ap√≥s o deploy, o Terraform gerar√° uma URL de endpoint e uma Chave de API. Para disparar o purge, fa√ßa a seguinte requisi√ß√£o:

* **M√©todo:** `POST`
* **Endpoint (URL):** `[URL_DE_INVOCACAO_DO_API_GATEWAY]/[STAGE]/[PATH]`
* **Header Obrigat√≥rio:**
    * `x-api-key`: `[VALOR_DA_API_KEY]`

**Exemplo (curl):**
```bash
curl -X POST \
  -H "x-api-key: SEU_VALOR_DA_API_KEY_AQUI" \
  "[https://xxxxx.execute-api.us-east-1.amazonaws.com/v1/purge-cache](https://xxxxx.execute-api.us-east-1.amazonaws.com/v1/purge-cache)"
```

## üì¶ Deploy (via GitHub Actions)

Este reposit√≥rio est√° configurado para deploy autom√°tico usando GitHub Actions.

### 1. Pr√©-requisitos

Configure os seguintes **Segredos** no seu reposit√≥rio GitHub (`Settings > Secrets and variables > Actions`):

* `AWS_ACCESS_KEY_ID`: Chave de acesso AWS.
* `AWS_SECRET_ACCESS_KEY`: Chave secreta AWS.
* `CLOUDFLARE_API_TOKEN`: Token da API do Cloudflare.
* `CLOUDFLARE_ZONE_ID`: ID da Zona do Cloudflare.
* `CLOUDFLARE_PREFIXES`: Lista de prefixos para limpar, separados por v√≠rgula (ex: `site1.com/,site2.com/`).
* `VPC_SUBNET_IDS`: IDs das subnets privadas, separadas por v√≠rgula (ex: `subnet-abc,subnet-xyz`).
* `VPC_SECURITY_GROUP_IDS`: IDs dos SGs, separados por v√≠rgula (ex: `sg-123`).

### 2. `main.tf`

* Voc√™ tamb√©m deve atualizar o arquivo `main.tf` para apontar para o seu pr√≥prio bucket S3 de armazenamento de estado (terraform state backend).

### 3. Executando o Deploy

Fa√ßa um push (ou merge) para o branch `main`. A Action ser√° disparada automaticamente, executando `terraform init`, `plan` e `apply`. Os outputs `api_endpoint_url` e `api_key_value` podem ser consultados nos logs da pipeline ou no console da AWS (API Gateway).

## üìú Licen√ßa

Este projeto √© licenciado sob a licen√ßa MIT.
````